---
title: "01 - Redlining in St. Louis"
author: "Your Name"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output: github_document
---

## Introduction
This notebook maps redlining boundaries to contemporary census tracts in St. Louis City and County.

## Dependencies
This notebook requires the following packages:

```{r load-packages}
# tidyverse packages
library(dplyr)

# spatial packages
library(sf)

# other packages
library(measurements)
```

## Load Data
This notebook requires redlining boundary data as well as the 2010 U.S. Census tract boundaries:

```{r load-data}
## tracts
tracts <- st_read(here::here("data", "STL_BOUNDARY_Tracts_2010", "STL_BOUNDARY_Tracts_2010.geojson")) %>%
  st_transform(crs = 26915)

## redlining
redlining_37 <- st_read(here::here("data", "STL_BOUNDARY_Redlining", "STL_BOUNDARY_Redlining_1937.geojson")) %>%
  st_transform(crs = 26915)

redlining_40 <- st_read(here::here("data", "STL_BOUNDARY_Redlining", "STL_BOUNDARY_Redlining_1940.geojson")) %>%
  st_transform(crs = 26915)
```
## Geoprocess Tracts
In order to determine the percent of each tract redlined, we need to know the total area of each tract. We'll calculate the area in square meters (based on the projected coordinate system in use), then convert it to square kilometers.

```{r tract-area}
tracts %>%
  mutate(total_area = st_area(geometry)) %>%
  mutate(total_area = as.vector(conv_unit(total_area, from = "m2", to = "km2"))) %>%
  select(GEOID, total_area) -> tracts
```

The square kilometers conversion isn't strictly speaking necessary for this application, but is included in-case it is needed later.

## Geoprocess 1937 Data
Next, we'll calculate the percent of tracts redlined in 1937. First, we need to figure out which tract each redlined area for the "C" and "D" grades falls into, and then combine adjacent areas within the same tract. Next, we'll repeat the workflow above for calculating the sqare kilometers redlined.

```{r 1937-step-1}
redlining_37 %>%  
  filter(grade %in% c("C", "D")) %>%
  st_intersection(., tracts) %>%
  group_by(GEOID) %>%
  summarise() %>%
  st_collection_extract(type = "POLYGON") %>%
  mutate(red_area = st_area(geometry)) %>%
  mutate(red_area = as.vector(conv_unit(red_area, from = "m2", to = "km2"))) %>%
  select(GEOID, red_area) -> redlining_37
```

With these calculations complete, we'll remove the geometry from the redlining data:

```{r 1937-step-2}
st_geometry(redlining_37) <- NULL
```

Finally, we'll merge our tract data with the 1937 redlining data, and convert the measurement data into a percentage:

```{r 1937-step-3}
tracts %>%
  left_join(., redlining_37, by = "GEOID") %>%
  mutate(pct_red_37 = red_area/total_area*100) %>%
  select(GEOID, pct_red_37) %>%
  mutate(pct_red_37 = ifelse(is.na(pct_red_37) == TRUE, 0, pct_red_37)) -> redlining_37
```

## Geoprocess 1940 Data
We'll use an identical workflow for the 1940 data:

```{r 1940-data}
## step 1
redlining_40 %>%  
  filter(grade %in% c("C", "D")) %>%
  st_intersection(., tracts) %>%
  group_by(GEOID) %>%
  summarise() %>%
  st_collection_extract(type = "POLYGON") %>%
  mutate(red_area = st_area(geometry)) %>%
  mutate(red_area = as.vector(conv_unit(red_area, from = "m2", to = "km2"))) %>%
  select(GEOID, red_area) -> redlining_40

## step 2
st_geometry(redlining_40) <- NULL

## step 3
tracts %>%
  left_join(., redlining_40, by = "GEOID") %>%
  mutate(pct_red_40 = red_area/total_area*100) %>%
  select(GEOID, pct_red_40) %>%
  mutate(pct_red_40 = ifelse(is.na(pct_red_40) == TRUE, 0, pct_red_40)) -> redlining_40
```

## Store Geoprocessed Data
Next, we'll store these as separate `.geojson` files:

```{r store-separately}
## 1937
redlining_37 %>%
  st_transform(crs = 4326) %>%
  st_write(here::here("data", "STL_BOUNDARY_Redlining", "STL_BOUNDARY_Tracts_1937.geojson"), delete_dsn = TRUE)

## 1940
redlining_40 %>%
  st_transform(crs = 4326) %>%
  st_write(here::here("data", "STL_BOUNDARY_Redlining", "STL_BOUNDARY_Tracts_1940.geojson"), delete_dsn = TRUE)
```

## Combine Into A Single File
Finally, for analysis, we'll combine these two percentages into a single object:

```{r store-combined}
## remove geometry
st_geometry(redlining_40) <- NULL

## combine and calculate percent change
left_join(redlining_37, redlining_40, by = "GEOID") %>%
  mutate(pct_change = (pct_red_40-pct_red_37)/pct_red_37*100) %>%
  st_transform(crs = 4326) %>%
  st_write(here::here("data", "STL_BOUNDARY_Redlining", "STL_BOUNDARY_Tracts_Combined.geojson"), delete_dsn = TRUE)
```

